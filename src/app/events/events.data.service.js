"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var event_1 = require("./event");
var calendar_data_service_1 = require("../calendar/calendar.data.service");
var Sqlite = require("nativescript-sqlite");
var EventsDataService = /** @class */ (function () {
    function EventsDataService(calendarDataService) {
        var _this = this;
        this.calendarDataService = calendarDataService;
        (new Sqlite("ZoroastrianCalendarSQLite.db3")).then(function (db) {
            db.execSQL("CREATE TABLE IF NOT EXISTS CalendarEvent(id INTEGER PRIMARY KEY AUTOINCREMENT, rojId INTEGER, mahId, INTEGER, sal INTEGER, title TEXT, description TEXT, calendarType TEXT, isPreloaded INTEGER, isDeleted INTEGER)").then(function (id) {
                _this.database = db;
            }, function (error) {
                console.log("CREATE TABLE ERROR", error);
            });
        }, function (error) {
            console.error("OPEN DB ERROR", error);
        });
    }
    EventsDataService.prototype.getAll = function () {
        return __awaiter(this, void 0, void 0, function () {
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.database.all("SELECT * FROM CalendarEvent WHERE isDeleted = 0").then(function (rows) { return __awaiter(_this, void 0, void 0, function () {
                            var row;
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        this.events = new Array();
                                        for (row in rows) {
                                            this.events.push(new event_1.ZCalendarEvent(rows[row][0], rows[row][1], rows[row][2], rows[row][3], rows[row][4], rows[row][5], rows[row][6]));
                                        }
                                        return [4 /*yield*/, this.events];
                                    case 1: return [2 /*return*/, _a.sent()];
                                }
                            });
                        }); }, function (error) {
                            console.log("SELECT ERROR", error);
                        })];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    EventsDataService.prototype.getRecurringEventsForDay = function (date) {
        var _this = this;
        var rojId = this.calendarDataService.getRojId(date.roj);
        var mahId = this.calendarDataService.getMahId(date.mah);
        var calendarType = date.calendarType;
        return this.database.all("SELECT * FROM CalendarEvent WHERE isDeleted = 0 and rojId = ? and mahId = ? and calendarType = ?", [rojId, mahId, calendarType]).then(function (rows) {
            _this.events = new Array();
            for (var row in rows) {
                _this.events.push(new event_1.ZCalendarEvent(rows[row][0], rows[row][1], rows[row][2], rows[row][3], rows[row][4], rows[row][5], rows[row][6]));
            }
            return _this.events;
        }, function (error) {
            console.log("SELECT ERROR", error);
        });
    };
    EventsDataService.prototype.upsert = function (entity) {
        if (entity.id === 0) {
            return this.database.execSQL("INSERT INTO CalendarEvent (rojId, mahId, sal, title, description, calendarType, isPreloaded, isDeleted) VALUES (?, ?, ?, ?, ?, ?, ?, ?)", [entity.rojId, entity.mahId, entity.sal, entity.title, entity.description, entity.calendarType, 0, 0]).then(function (id) {
                entity.id = id;
                return entity;
            }, function (error) {
                console.log("INSERT ERROR", error);
            });
        }
        else {
            return this.database.execSQL("UPDATE CalendarEvent SET rojId = ?, mahId = ?, sal = ?, title = ?, description = ?, calendarType = ? WHERE id = ?", [entity.rojId, entity.mahId, entity.sal, entity.title, entity.description, entity.calendarType, entity.id]).then(function (noOfRecords) {
                if (noOfRecords !== 1) {
                    console.log("UPSERT ERROR - number of records updated: " + noOfRecords + ", expected: 1");
                }
                return entity;
            }, function (error) {
                console.log("UPDATE ERROR", error);
            });
        }
    };
    EventsDataService.prototype.recycle = function (entity) {
        return this.database.execSQL("UPDATE CalendarEvent SET isDeleted = ? WHERE id = ?", [1, entity.id]).then(function (noOfRecords) {
            if (noOfRecords !== 1) {
                console.log("RECYCLE ERROR - number of records updated: " + noOfRecords + ", expected: 1");
            }
            return noOfRecords;
        }, function (error) {
            console.log("UPDATE ERROR", error);
        });
    };
    EventsDataService.prototype.restore = function (entity) {
        return this.database.execSQL("UPDATE CalendarEvent SET isDeleted = ? WHERE id = ?", [0, entity.id]).then(function (noOfRecords) {
            if (noOfRecords !== 1) {
                console.log("RESTORE ERROR - number of records updated: " + noOfRecords + ", expected: 1");
            }
            return noOfRecords;
        }, function (error) {
            console.log("UPDATE ERROR", error);
        });
    };
    EventsDataService.prototype.purge = function (entity) {
        return this.database.execSQL("DELETE FROM CalendarEvent WHERE id = ?", [entity.id]).then(function (noOfRecords) {
            if (noOfRecords !== 1) {
                console.log("PURGE ERROR - number of records updated: " + noOfRecords + ", expected: 1");
            }
            return noOfRecords;
        }, function (error) {
            console.log("DELETE ERROR", error);
        });
    };
    EventsDataService = __decorate([
        core_1.Injectable({
            providedIn: "root"
        }),
        __metadata("design:paramtypes", [calendar_data_service_1.CalendarDataService])
    ], EventsDataService);
    return EventsDataService;
}());
exports.EventsDataService = EventsDataService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnRzLmRhdGEuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImV2ZW50cy5kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMkM7QUFDM0MsaUNBQXlDO0FBRXpDLDJFQUF3RTtBQUN4RSxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUs1QztJQUdJLDJCQUFzQixtQkFBd0M7UUFBOUQsaUJBVUM7UUFWcUIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUMxRCxDQUFDLElBQUksTUFBTSxDQUFDLCtCQUErQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxFQUFFO1lBQ2pELEVBQUUsQ0FBQyxPQUFPLENBQUMscU5BQXFOLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxFQUFFO2dCQUNyTyxLQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztZQUN2QixDQUFDLEVBQUUsVUFBQSxLQUFLO2dCQUNKLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDN0MsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLEVBQUUsVUFBQSxLQUFLO1lBQ0osT0FBTyxDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUssa0NBQU0sR0FBWjs7Ozs7NEJBQ1cscUJBQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsaURBQWlELENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBTSxJQUFJOzs7Ozt3Q0FDN0YsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEtBQUssRUFBa0IsQ0FBQzt3Q0FDMUMsS0FBUyxHQUFHLElBQUksSUFBSSxFQUFFOzRDQUNsQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLHNCQUFjLENBQUMsSUFBSSxDQUFDLEdB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bGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBaQ2FsZW5kYXJFdmVudCB9IGZyb20gXCIuL2V2ZW50XCI7XHJcbmltcG9ydCB7IFpEYXRlIH0gZnJvbSBcIi4uL2NhbGVuZGFyL2NhbGVuZGFyLm1vZGVsc1wiO1xyXG5pbXBvcnQgeyBDYWxlbmRhckRhdGFTZXJ2aWNlIH0gZnJvbSBcIi4uL2NhbGVuZGFyL2NhbGVuZGFyLmRhdGEuc2VydmljZVwiO1xyXG52YXIgU3FsaXRlID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC1zcWxpdGVcIik7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiBcInJvb3RcIlxyXG59KVxyXG5leHBvcnQgY2xhc3MgRXZlbnRzRGF0YVNlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSBkYXRhYmFzZTogYW55O1xyXG4gICAgZXZlbnRzOiBBcnJheTxaQ2FsZW5kYXJFdmVudD47XHJcbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgY2FsZW5kYXJEYXRhU2VydmljZTogQ2FsZW5kYXJEYXRhU2VydmljZSkge1xyXG4gICAgICAgIChuZXcgU3FsaXRlKFwiWm9yb2FzdHJpYW5DYWxlbmRhclNRTGl0ZS5kYjNcIikpLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgICAgICBkYi5leGVjU1FMKFwiQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgQ2FsZW5kYXJFdmVudChpZCBJTlRFR0VSIFBSSU1BUlkgS0VZIEFVVE9JTkNSRU1FTlQsIHJvaklkIElOVEVHRVIsIG1haElkLCBJTlRFR0VSLCBzYWwgSU5URUdFUiwgdGl0bGUgVEVYVCwgZGVzY3JpcHRpb24gVEVYVCwgY2FsZW5kYXJUeXBlIFRFWFQsIGlzUHJlbG9hZGVkIElOVEVHRVIsIGlzRGVsZXRlZCBJTlRFR0VSKVwiKS50aGVuKGlkID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGF0YWJhc2UgPSBkYjtcclxuICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJDUkVBVEUgVEFCTEUgRVJST1JcIiwgZXJyb3IpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJPUEVOIERCIEVSUk9SXCIsIGVycm9yKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBnZXRBbGwoKTogUHJvbWlzZTxBcnJheTxaQ2FsZW5kYXJFdmVudD4+IHtcclxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5kYXRhYmFzZS5hbGwoXCJTRUxFQ1QgKiBGUk9NIENhbGVuZGFyRXZlbnQgV0hFUkUgaXNEZWxldGVkID0gMFwiKS50aGVuKGFzeW5jIHJvd3MgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmV2ZW50cyA9IG5ldyBBcnJheTxaQ2FsZW5kYXJFdmVudD4oKTtcclxuICAgICAgICAgICAgZm9yICh2YXIgcm93IGluIHJvd3MpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzLnB1c2gobmV3IFpDYWxlbmRhckV2ZW50KHJvd3Nbcm93XVswXSwgcm93c1tyb3ddWzFdLCByb3dzW3Jvd11bMl0sIHJvd3Nbcm93XVszXSwgcm93c1tyb3ddWzRdLCByb3dzW3Jvd11bNV0sIHJvd3Nbcm93XVs2XSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV2ZW50cztcclxuICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU0VMRUNUIEVSUk9SXCIsIGVycm9yKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRSZWN1cnJpbmdFdmVudHNGb3JEYXkoZGF0ZTogWkRhdGUpOiBQcm9taXNlPEFycmF5PFpDYWxlbmRhckV2ZW50Pj4ge1xyXG4gICAgICAgIHZhciByb2pJZCA9IHRoaXMuY2FsZW5kYXJEYXRhU2VydmljZS5nZXRSb2pJZChkYXRlLnJvaik7XHJcbiAgICAgICAgdmFyIG1haElkID0gdGhpcy5jYWxlbmRhckRhdGFTZXJ2aWNlLmdldE1haElkKGRhdGUubWFoKTtcclxuICAgICAgICB2YXIgY2FsZW5kYXJUeXBlID0gZGF0ZS5jYWxlbmRhclR5cGU7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YWJhc2UuYWxsKFwiU0VMRUNUICogRlJPTSBDYWxlbmRhckV2ZW50IFdIRVJFIGlzRGVsZXRlZCA9IDAgYW5kIHJvaklkID0gPyBhbmQgbWFoSWQgPSA/IGFuZCBjYWxlbmRhclR5cGUgPSA/XCIsIFtyb2pJZCwgbWFoSWQsIGNhbGVuZGFyVHlwZV0pLnRoZW4ocm93cyA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gbmV3IEFycmF5PFpDYWxlbmRhckV2ZW50PigpO1xyXG4gICAgICAgICAgICBmb3IgKHZhciByb3cgaW4gcm93cykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ldmVudHMucHVzaChuZXcgWkNhbGVuZGFyRXZlbnQocm93c1tyb3ddWzBdLCByb3dzW3Jvd11bMV0sIHJvd3Nbcm93XVsyXSwgcm93c1tyb3ddWzNdLCByb3dzW3Jvd11bNF0sIHJvd3Nbcm93XVs1XSwgcm93c1tyb3ddWzZdKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRzO1xyXG4gICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTRUxFQ1QgRVJST1JcIiwgZXJyb3IpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVwc2VydChlbnRpdHk6IFpDYWxlbmRhckV2ZW50KTogUHJvbWlzZTxaQ2FsZW5kYXJFdmVudD4ge1xyXG4gICAgICAgIGlmIChlbnRpdHkuaWQgPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YWJhc2UuZXhlY1NRTChcIklOU0VSVCBJTlRPIENhbGVuZGFyRXZlbnQgKHJvaklkLCBtYWhJZCwgc2FsLCB0aXRsZSwgZGVzY3JpcHRpb24sIGNhbGVuZGFyVHlwZSwgaXNQcmVsb2FkZWQsIGlzRGVsZXRlZCkgVkFMVUVTICg/LCA/LCA/LCA/LCA/LCA/LCA/LCA/KVwiLCBbZW50aXR5LnJvaklkLCBlbnRpdHkubWFoSWQsIGVudGl0eS5zYWwsIGVudGl0eS50aXRsZSwgZW50aXR5LmRlc2NyaXB0aW9uLCBlbnRpdHkuY2FsZW5kYXJUeXBlLCAwLCAwXSkudGhlbihpZCA9PiB7XHJcbiAgICAgICAgICAgICAgICBlbnRpdHkuaWQgPSBpZDtcclxuICAgICAgICAgICAgICAgIHJldHVybiBlbnRpdHk7XHJcbiAgICAgICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiSU5TRVJUIEVSUk9SXCIsIGVycm9yKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YWJhc2UuZXhlY1NRTChcIlVQREFURSBDYWxlbmRhckV2ZW50IFNFVCByb2pJZCA9ID8sIG1haElkID0gPywgc2FsID0gPywgdGl0bGUgPSA/LCBkZXNjcmlwdGlvbiA9ID8sIGNhbGVuZGFyVHlwZSA9ID8gV0hFUkUgaWQgPSA/XCIsIFtlbnRpdHkucm9qSWQsIGVudGl0eS5tYWhJZCwgZW50aXR5LnNhbCwgZW50aXR5LnRpdGxlLCBlbnRpdHkuZGVzY3JpcHRpb24sIGVudGl0eS5jYWxlbmRhclR5cGUsIGVudGl0eS5pZF0pLnRoZW4obm9PZlJlY29yZHMgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vT2ZSZWNvcmRzICE9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJVUFNFUlQgRVJST1IgLSBudW1iZXIgb2YgcmVjb3JkcyB1cGRhdGVkOiBcIiArIG5vT2ZSZWNvcmRzICsgXCIsIGV4cGVjdGVkOiAxXCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJVUERBVEUgRVJST1JcIiwgZXJyb3IpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVjeWNsZShlbnRpdHk6IFpDYWxlbmRhckV2ZW50KTogUHJvbWlzZTxudW1iZXI+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhYmFzZS5leGVjU1FMKFwiVVBEQVRFIENhbGVuZGFyRXZlbnQgU0VUIGlzRGVsZXRlZCA9ID8gV0hFUkUgaWQgPSA/XCIsIFsxLCBlbnRpdHkuaWRdKS50aGVuKG5vT2ZSZWNvcmRzID0+IHtcclxuICAgICAgICAgICAgaWYgKG5vT2ZSZWNvcmRzICE9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlJFQ1lDTEUgRVJST1IgLSBudW1iZXIgb2YgcmVjb3JkcyB1cGRhdGVkOiBcIiArIG5vT2ZSZWNvcmRzICsgXCIsIGV4cGVjdGVkOiAxXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBub09mUmVjb3JkcztcclxuICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVVBEQVRFIEVSUk9SXCIsIGVycm9yKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXN0b3JlKGVudGl0eTogWkNhbGVuZGFyRXZlbnQpOiBQcm9taXNlPG51bWJlcj4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFiYXNlLmV4ZWNTUUwoXCJVUERBVEUgQ2FsZW5kYXJFdmVudCBTRVQgaXNEZWxldGVkID0gPyBXSEVSRSBpZCA9ID9cIiwgWzAsIGVudGl0eS5pZF0pLnRoZW4obm9PZlJlY29yZHMgPT4ge1xyXG4gICAgICAgICAgICBpZiAobm9PZlJlY29yZHMgIT09IDEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUkVTVE9SRSBFUlJPUiAtIG51bWJlciBvZiByZWNvcmRzIHVwZGF0ZWQ6IFwiICsgbm9PZlJlY29yZHMgKyBcIiwgZXhwZWN0ZWQ6IDFcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG5vT2ZSZWNvcmRzO1xyXG4gICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJVUERBVEUgRVJST1JcIiwgZXJyb3IpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1cmdlKGVudGl0eTogWkNhbGVuZGFyRXZlbnQpOiBQcm9taXNlPG51bWJlcj4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFiYXNlLmV4ZWNTUUwoXCJERUxFVEUgRlJPTSBDYWxlbmRhckV2ZW50IFdIRVJFIGlkID0gP1wiLCBbZW50aXR5LmlkXSkudGhlbihub09mUmVjb3JkcyA9PiB7XHJcbiAgICAgICAgICAgIGlmIChub09mUmVjb3JkcyAhPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJQVVJHRSBFUlJPUiAtIG51bWJlciBvZiByZWNvcmRzIHVwZGF0ZWQ6IFwiICsgbm9PZlJlY29yZHMgKyBcIiwgZXhwZWN0ZWQ6IDFcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG5vT2ZSZWNvcmRzO1xyXG4gICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJERUxFVEUgRVJST1JcIiwgZXJyb3IpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59Il19